# 番茄钟完善迭代设计（macOS 菜单栏版）

日期：2026-02-03

## 目标
- 修复“阶段结束无提醒”的核心缺口，保证应用在隐藏状态也能可靠提醒。
- 在 3-4 周内完成体验、稳定性、数据复盘、专注辅助四个方向的核心改进。
- 保持当前菜单栏交互规则：不在 tick 中更新菜单项，只更新托盘标题。

## 范围与约束
- 仅覆盖 macOS 菜单栏场景。
- 通知方式：系统通知 + 系统默认提示音。
- `autoStart=false` 时仍需提醒，但不自动进入运行态。
- 数据仅本地存储（无跨设备同步）。

## 迭代节奏（完整版 3-4 周）
- 里程碑 1（第 1 周）：阶段结束提醒、菜单快捷操作优化、防误触与中断记录。
- 里程碑 2（第 2-3 周）：统计数据模型与本地落盘、今日/本周统计视图、连续天数与平均专注时长。
- 里程碑 3（第 3-4 周）：睡眠/唤醒校准、计时稳定性优化、菜单栏视觉反馈。

## 提醒设计
- 阶段切换由 Rust 端判定：`TimerEngine::tick()` 触发 `advance_phase()` 的瞬间视为阶段切换。
- 在主循环里对比 `snapshot.phase` 与 `last_phase`，仅在变化时发送提醒，避免重复提醒。
- 通知文案采用简洁模板：例如“专注结束，休息开始”。
- 仍发出 `timer:phase_changed` 事件，供统计与 UI 使用。

## 统计与复盘（本地）
- 存储：`app_config_dir/stats.json`，按自然日聚合。
- 指标（标准版）：今日/本周完成番茄数、专注时长、休息时长、中断次数、平均专注时长、连续天数。
- 中断定义：仅在“专注阶段”手动暂停或跳过计数。
- 统计更新时机：阶段切换时写入（Focus->Break 计完成专注，Break->Focus 计休息时长）。

## 体验优化
- 菜单快捷操作：状态行显示“当前阶段 + 剩余 + 下一阶段提示”。
- 防误触：跳过/重置采用二次确认菜单项（3 秒内再次点击生效）。
- 视觉反馈：偏好页与 Web 预览页显示阶段颜色/进度与番茄计数。

## 稳定性
- 睡眠/唤醒校准：记录相邻 tick 的 wall-clock 时间，若间隔异常则按差值修正 `remaining_ms` 与 `end_at`。
- 通知/音频失败不阻断计时，仅记录日志。

## 测试与验收
- 阶段结束提醒触发（含 `autoStart=false`）。
- 二次确认菜单项行为与超时回退。
- 统计数据跨日切换正确；连续天数与平均时长正确。
- 睡眠/唤醒后时间校准与阶段切换正确。
